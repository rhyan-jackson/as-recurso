<%= turbo_frame_tag "modal-content" do %>
  <div class="modal-header">
    <h1>üèÅ Terminar Viagem</h1>
    <button data-action="click->modal#close" class="close-button">&times;</button>
  </div>

  <div class="end-ride-confirmation">
    <h2>Confirmar Fim da Viagem</h2>
    
    <div class="trip-summary">
      <div class="bike-info">
        <h3>üö¥‚Äç‚ôÄÔ∏è Sua Viagem</h3>
        <p><strong>Bicicleta:</strong> <%= @ride.bike.brand %> #<%= @ride.bike.id %></p>
        <p><strong>Origem:</strong> <%= @ride.origin_station.name %></p>
        <p><strong>Destino Final:</strong> <%= @destination_station.name %></p>
      </div>
      
      <div class="time-info">
        <h3>‚è±Ô∏è Dura√ß√£o</h3>
        <p><strong>In√≠cio:</strong> <%= @ride.start_time.strftime("%H:%M") %></p>
        <p><strong>Fim:</strong> <%= Time.current.strftime("%H:%M") %></p>
        <p><strong>Dura√ß√£o Total:</strong> <%= (@actual_duration_hours * 60).round %> minutos</p>
      </div>
      
      <div class="cost-breakdown">
        <h3>üí∞ Custos</h3>
        <div class="cost-item">
          <span>Custo inicial:</span>
          <span><%= @ride.price %>‚Ç¨</span>
        </div>
        
        <% if @additional_cost > 0 %>
          <div class="cost-item additional">
            <span>Tempo extra:</span>
            <span>+<%= @additional_cost.round(2) %>‚Ç¨</span>
          </div>
          <hr>
          <div class="cost-item total">
            <strong>
              <span>Total:</span>
              <span><%= @total_cost.round(2) %>‚Ç¨</span>
            </strong>
          </div>
        <% else %>
          <div class="cost-item total">
            <strong>
              <span>Total:</span>
              <span><%= @ride.price %>‚Ç¨</span>
            </strong>
          </div>
          <p class="no-extra"><small>‚úÖ Sem custos adicionais!</small></p>
        <% end %>
      </div>
      
      <div class="balance-info">
        <% if @additional_cost > 0 %>
          <% new_balance = Current.user.customer.balance - @additional_cost %>
          <p><strong>Saldo atual:</strong> <%= Current.user.customer.balance %>‚Ç¨</p>
          <p><strong>Custo adicional:</strong> -<%= @additional_cost.round(2) %>‚Ç¨</p>
          <p><strong>Saldo ap√≥s viagem:</strong> <%= new_balance.round(2) %>‚Ç¨</p>
          
          <% if new_balance < 0 %>
            <div class="insufficient-balance">
              ‚ö†Ô∏è <strong>Saldo insuficiente para custos adicionais!</strong>
            </div>
          <% end %>
        <% else %>
          <p><strong>Saldo atual:</strong> <%= Current.user.customer.balance %>‚Ç¨</p>
          <p class="no-charge">‚úÖ Sem cobran√ßa adicional</p>
        <% end %>
      </div>
    </div>
    
    <div class="confirmation-actions">
      <% if @additional_cost > 0 && Current.user.customer.balance < @additional_cost %>
        <div class="insufficient-funds">
          <p>√â necess√°rio carregar saldo para cobrir os custos adicionais.</p>
          <%= link_to "üí∞ Carregar Saldo", new_payment_path(Current.user.customer), class: "btn btn-primary" %>
          <%= link_to "‚Üê Cancelar", stations_path, 
              class: "btn btn-secondary", 
              data: { action: "click->modal#close" } %>
        </div>
      <% else %>
          <%= form_with model: @ride, url: ride_path(@ride), method: :patch, local: false do |f| %>
          <%= f.hidden_field :destination_station_id, value: @destination_station.id %>
          <%= f.hidden_field :additional_cost, value: @additional_cost %>
  
          <button type="submit" class="btn btn-success btn-large">
              ‚úÖ Confirmar e Terminar Viagem
          </button>
        <% end %>
        
        <%= link_to "‚Üê Cancelar", stations_path, 
            class: "btn btn-secondary",
            data: { action: "click->modal#close" } %>
      <% end %>
    </div>
  </div>
<% end %>